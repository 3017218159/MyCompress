var console=console||{log:function(){return false}};window.onload=function(){console.log("v0.0.2");var e=navigator.userAgent;var t=new Array("Android","iPhone","SymbianOS","Windows Phone","iPad","iPod");is_mobile=false;for(var n=0;n<t.length;n++){if(e.indexOf(t[n])>0){is_mobile=true;break}}config_xml=new ParseXML(coursePath+"/data/whatyPresentation.xml");if(!config_xml){alert("课件结构错误")}else{var o=$(".copyright");if(o&&config_xml.copyright){o.text(config_xml.copyright)}else{o.hide()}init_course()}};function begin_to_play(){if(is_mobile){$(".wrap").hide();$(".mobile_wrap").show();init_mobile()}else{init_pc()}}function not_yunpan_url(){if(config_xml.video.length>0&&!endsWith(config_xml.video,"meta.json")&&config_xml.video.indexOf("http://")==-1){config_xml.video=config_xml.video}if(config_xml.videocloud){if(!endsWith(config_xml.videocloud,"meta.json")){config_xml.videoSegPath="videoForSeg/yunPan/"+config_xml.videocloud+".VIDEOSEGMENTS/meta.json"}}else{if(endsWith(config_xml.video,"meta.json")){config_xml.videoSegPath=config_xml.video;config_xml.video=""}}begin_to_play()}function init_course(){var e=/http.{3,5}yunpan\.webtrn\.cn\/.+openhtmlcontent\/(.+)\/false\/(.+\/)index\.htm/.test(parent.document.location.href);var t=/.*meta\.json/.test(config_xml.video);if(e&&!t){var n=RegExp.$1;var o=RegExp.$2;$.ajax({type:"get",url:"http://yunpan.sdk.webtrn.cn/api/shares/info?shareid="+n,dataType:"json",success:function(e){if(e.statusLine===200){var t=e.userid;var i="http://yunpan.sdk.webtrn.cn/api/play/share-video/uri?shareId="+n+"&path="+o+config_xml.video;config_xml.video="http://yunpan.sdk.webtrn.cn/api/play/mp4?path="+decodeURI(o+config_xml.video)+"&userId="+t;$.ajax({type:"get",url:i,dataType:"json",success:function(e){config_xml.videoSegPath=e.videoURL;begin_to_play()},error:function(e){not_yunpan_url()}})}else{not_yunpan_url()}},error:function(){not_yunpan_url()}})}else{not_yunpan_url()}}function init_mobile(){var e=document.getElementById("s-video");e.onerror=function(){alert("视频无法播放，请联系视频提供方")};e.oncanplay=function(){console.log("video can play")};e.src=config_xml.video;console.log("local video")}function init_pc(){$(window).resize(function(){resize_element()});$(window).trigger("resize");$("coursename").text(config_xml.title);var e="";if(config_xml.captionType=="srt"){e=config_xml.caption}loadVideo({element_id:"flash_player",url:config_xml.video,seg_url:config_xml.videoSegPath,play_seg:config_xml.videoSegPath&&config_xml.videoSegPath.length>0,startTime:0,subtitle_url:e,show_caption:true,with_controls:true})}function resize_element(){var e=$(".copyright");var t=0;if(e&&e.is(":visible")){t=e.height()}var n=$(window).width();var o=$(window).height();var i=o-$(".title").height()-t;var l=i*4/3;$(".wrap").height(o);$(".wrap").width(l);$(".videomain").height(i);$(".videomain").width(l)}function ParseXML(e){this.xmlPath=e;var t=loadXML(this.xmlPath);if(!t||!t.firstChild){return null}var n=t.getElementsByTagName("properties")[0];var o=n.getElementsByTagName("title");this.title=GetCheckedNodeValue(o);o=n.getElementsByTagName("creationdate");this.creationdate=GetCheckedNodeValue(o);o=n.getElementsByTagName("totaltime");this.totaltime=GetCheckedNodeValue(o);o=n.getElementsByTagName("video");this.video=GetCheckedNodeValue(o);o=n.getElementsByTagName("videocloud");this.videocloud=GetCheckedNodeValue(o);o=n.getElementsByTagName("screen");this.screen=GetCheckedNodeValue(o);o=n.getElementsByTagName("screencloud");this.screencloud=GetCheckedNodeValue(o);o=n.getElementsByTagName("caption");this.caption=GetCheckedNodeValue(o);o=n.getElementsByTagName("copyright");this.copyright=GetCheckedNodeValue(o);if(this.video.length<=0&&this.screen.length>0){this.video=this.screen}}function loadXML(e){var t;if(window.XMLHttpRequest){xmlhttp=new XMLHttpRequest}else{xmlhttp=new ActiveXObject("Microsoft.XMLHTTP")}xmlhttp.open("GET",e,false);xmlhttp.send();t=xmlhttp.responseXML;return t}function loadx(e){var t="";if(window.ActiveXObject){var n=new Array("MSXML2.DOMDocument.6.0","MSXML2.DOMDocument.5.0","MSXML2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","Microsoft.XMLDOM","MSXML.DOMDocument");for(var o=0;o<n.length;o++){try{t=new ActiveXObject(n[o])}catch(e){continue}if(t)break}}else if(document.implementation&&document.implementation.createDocument){t=document.implementation.createDocument("","",null)}else{alert("can not create XML DOM object, update your browser please...")}t.async=true;t.load(e);return t}function GetCheckedNodeValue(e,t){if(e==null||e.length==0)return null;if(e[0].firstChild==null)return null;if(e[0].firstChild.nodeValue!=null)return e[0].firstChild.nodeValue;else return null}function endsWith(e,t){return e.indexOf(t,e.length-t.length)!==-1}function isIE(){return/msie/.test(navigator.userAgent.toLowerCase())}function check_url(e){if(isIE()&&window.XDomainRequest){var t=new XDomainRequest;t.open("get",e.url);t.onload=function(){e.onDone()};t.onerror=function(){e.onError()};t.send()}else{$.get(e.url).done(e.onDone).fail(e.onError)}}function GetCoursePath(e,t){t=typeof t!=="undefined"?t:document.location.href;var n;var o;for(var i=0;i<e;i++){o=t.lastIndexOf("/");t=t.substring(0,o)}o=t.lastIndexOf("/");n=t.substring(o+1);return n}function loadVideo(e){console.log(e.play_seg?"playing segments video.":"playing local video.");var t=e.play_seg?e.seg_url:e.url;var n=jwplayer(e.element_id).setup({file:encodeURI(t),playbackrates:[3,2,1.5,1],type:e.play_seg?"flvlist":"mp4",width:"100%",height:"100%",primary:"flash",show_audio_level:true,controls:e.with_controls,tracks:[{file:e.subtitle_url,kind:"captions",default:true}],captions:{color:"#FFFFFF",backgroundOpacity:20,fontfamily:"微软雅黑"},autostart:true}).seek(e.startTime);n.onReady(function(t){n.setCurrentCaptions(e.show_caption)});n.onError(function(t){if(t.message&&t.message.match("meta.json")){if(e.play_seg){console.log("change to local video.");this.remove();e.play_seg=false;loadVideo(e)}else{console.log("play local error.")}}else{console.log("play segment error.")}})}